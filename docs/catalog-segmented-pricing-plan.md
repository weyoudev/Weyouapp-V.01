# Catalog Segmented Pricing — Implementation Plan

## 1. Files Involved (Exact Paths)

### Backend (NestJS + Prisma)

| Path | Action |
|------|--------|
| `apps/api/src/infra/prisma/schema.prisma` | Add enum `Segment`; add models `ServiceCategory`, `ItemSegmentServicePrice`; add relation from `LaundryItem` to `ItemSegmentServicePrice` |
| `apps/api/src/infra/prisma/migrations/<timestamp>_add_segmented_pricing/migration.sql` | New migration (generated by Prisma) |
| `apps/api/src/application/ports/laundry-items-repo.port.ts` | Extend (optional) or add new port for “get item with matrix” if needed |
| `apps/api/src/application/ports/` | Add `service-category-repo.port.ts`, `item-segment-service-price-repo.port.ts` |
| `apps/api/src/application/catalog/list-catalog-items-with-matrix.use-case.ts` | New |
| `apps/api/src/application/catalog/update-catalog-item-with-matrix.use-case.ts` | New (transactional: item + matrix) |
| `apps/api/src/application/catalog/create-service-category.use-case.ts` | New |
| `apps/api/src/application/catalog/import-catalog-from-file.use-case.ts` | New (CSV; row-level validation) |
| `apps/api/src/infra/prisma/repos/prisma-service-category-repo.ts` | New |
| `apps/api/src/infra/prisma/repos/prisma-item-segment-service-price-repo.ts` | New |
| `apps/api/src/infra/prisma/repos/index.ts` | Export new repos |
| `apps/api/src/infra/infra.module.ts` | Register new repos + symbols |
| `apps/api/src/api/admin/controllers/admin-catalog.controller.ts` | Add routes: GET/PUT under catalog matrix; POST service-categories; POST import; GET import/sample. Keep existing GET/POST/PATCH/PUT :id/prices for backward compat |
| `apps/api/src/api/admin/services/admin-catalog.service.ts` | Use new use cases; add listWithMatrix, updateItemWithMatrix, createServiceCategory, importFromFile, getImportSample |
| `apps/api/src/api/admin/dto/` | Add DTOs: update-item-with-matrix.dto.ts, create-service-category.dto.ts, import-catalog.dto.ts (file or body) |
| `scripts/seed.ts` | Seed `ServiceCategory` from existing `ServiceType` enum; optionally seed `ItemSegmentServicePrice` from existing `LaundryItemPrice` (default segment) |

### Admin Web (Next.js)

| Path | Action |
|------|--------|
| `apps/admin-web/app/(protected)/catalog/page.tsx` | Replace table with card layout; add header buttons “Download sample”, “Upload Excel” (CSV); remove Edit Prices button; single “Edit” opens unified modal |
| `apps/admin-web/components/catalog/EditPricesModal.tsx` | Remove (replaced by unified Edit Item modal) |
| `apps/admin-web/components/catalog/EditItemModal.tsx` | Redesign: name, active, segments (MEN/WOMEN/KIDS/HOME_LINEN) with expandable sections; per-segment list of service categories with price (₹ int) + active; “Add service category” control; Save calls new PUT item-with-matrix API |
| `apps/admin-web/components/catalog/AddItemModal.tsx` | No change (or minimal: keep as-is) |
| `apps/admin-web/components/catalog/CatalogCard.tsx` | New: card showing name, active badge/toggle, compact price matrix (Segment → Service → ₹), Edit action |
| `apps/admin-web/hooks/useCatalog.ts` | Add `useCatalogItemsWithMatrix()`, `useUpdateItemWithMatrix(itemId)`, `useServiceCategories()`, `useCreateServiceCategory()`, `useImportCatalog()`; keep existing hooks for backward compat if still used |
| `apps/admin-web/types/catalog.ts` | Add types: `Segment`, `ServiceCategory`, `ItemSegmentServicePrice`, `CatalogItemWithMatrix`, `UpdateItemWithMatrixBody`, etc. |

### Docs

| Path | Action |
|------|--------|
| `docs/catalog-segmented-pricing-plan.md` | This plan (create) |

---

## 2. UI Change Checklist + Acceptance Criteria

### Catalog listing (card layout)

- [ ] **C1** Table is replaced by a responsive card grid; each card represents one catalog item.
- [ ] **C2** Each card shows: item name, overall Active/Inactive badge and toggle (same behavior as today), compact “price matrix” (Segment → Service → ₹). Only show combinations that exist; use “—” or hide row if no prices for that segment.
- [ ] **C3** Each card has one primary “Edit” action (opens unified Edit Item modal). No separate “Edit prices” or “Prices” button.
- [ ] **C4** Catalog header has two buttons: “Download sample” (downloads sample CSV with expected columns), “Upload Excel” (accepts .csv first; label can say “Upload” and support CSV; if Excel lib added later, support .xlsx).

### Unified “Edit Item” modal

- [ ] **E1** One modal edits: item name, overall active toggle, and segmented prices.
- [ ] **E2** Segments: MEN, WOMEN, KIDS, HOME_LINEN — each as expandable section. Inside each segment: list of service categories with price input (₹ integer, ≥ 0) and active toggle per service.
- [ ] **E3** User can add a new service category from the modal (“Add service category”) that creates a global `ServiceCategory` and then allows using it in the matrix.
- [ ] **E4** Save: one API call (PUT item-with-matrix) persists name, active, and all segment–service–price rows. Success toast and list refresh (invalidate TanStack Query).
- [ ] **E5** Validation: name required; price integer ≥ 0; blank price treated as “not set” (remove combination or set inactive). Toggling a service off marks it inactive and it appears inactive on the card.

### Import/Export

- [ ] **I1** “Download sample” returns a CSV file with columns: itemName, segment, serviceCategoryCode, priceRupees, isActive (and any headers needed for “create item if not exists”).
- [ ] **I2** “Upload” accepts CSV; creates item by name if not exists, creates missing service categories, upserts segment–service prices; returns summary (created items, updated items, errors by row).
- [ ] **I3** No new heavy Excel lib if not already present; implement CSV first; button can remain “Download sample” / “Upload” with CSV in the spec.

### Bug fix

- [ ] **B1** Current “Edit prices” modal is removed; its Save path is no longer used. The bug (SERVICE_TYPES containing `'WASH&FOLD'` instead of `'WASH_FOLD'` in `EditPricesModal.tsx`) is resolved by replacing the flow with the new modal and API.

---

## 3. DB/Backend Change Checklist + Migration Notes

### Prisma schema

- [ ] **D1** Add enum `Segment`: `MEN`, `WOMEN`, `KIDS`, `HOME_LINEN`.
- [ ] **D2** Add model `ServiceCategory`: `id`, `code` (unique string), `label` (string), `isActive` (bool), `createdAt`.
- [ ] **D3** Add model `ItemSegmentServicePrice`: `id`, `itemId` (FK → LaundryItem), `segment` (enum), `serviceCategoryId` (FK → ServiceCategory), `priceRupees` (int), `isActive` (bool), `createdAt`, `updatedAt`; unique `(itemId, segment, serviceCategoryId)`.
- [ ] **D4** Do not remove or rename `LaundryItem`, `LaundryItemPrice`, or `ServiceType`; no change to `Order`, `OrderItem`, `Invoice`, `InvoiceItem`.

### Backward compatibility

- [ ] **D5** Seed `ServiceCategory` with rows for each existing `ServiceType` enum value (code = enum string, e.g. `STEAM_IRON`, `DRY_CLEAN`).
- [ ] **D6** Existing endpoints remain: `GET /admin/items`, `PATCH /admin/items/:id`, `PUT /admin/items/:id/prices`. Order/invoice flows continue to use `LaundryItemPrice` and `ServiceType`; no changes to those modules except optional adapter if we sync a “default segment” from matrix to `LaundryItemPrice` (see implementation step).
- [ ] **D7** New admin endpoints: e.g. `GET /admin/catalog/items` (items + segmented prices + service categories), `PUT /admin/catalog/items/:id` (update name, active, full matrix), `POST /admin/catalog/service-categories`, `POST /admin/catalog/import` (file/CSV), `GET /admin/catalog/import/sample` (CSV bytes).

### Application layer

- [ ] **D8** Use cases: `ListCatalogItemsWithMatrix`, `UpdateCatalogItemWithMatrix` (in one transaction), `CreateServiceCategory`, `ImportCatalogFromFile` (CSV, row validation).
- [ ] **D9** Repositories: `ServiceCategoryRepository` (CRUD + list), `ItemSegmentServicePriceRepository` (list by item, upsert by item+segment+serviceCategory, delete orphan rows on full replace). Optional: extend or add read that joins item + matrix.

### Migration notes

- Create migration after schema change: `npx prisma migrate dev --name add_segmented_pricing`.
- Seed script: after migrations, ensure `ServiceCategory` is populated from `ServiceType`; optionally backfill `ItemSegmentServicePrice` from existing `LaundryItemPrice` using a default segment (e.g. MEN) so existing items show in new UI without manual re-entry.

---

## 4. Step-by-Step Implementation Plan (Order)

1. **Prisma schema**  
   Add `Segment` enum, `ServiceCategory`, `ItemSegmentServicePrice`; add relation on `LaundryItem` to `segmentPrices` (or similar). Run migration.

2. **Seed**  
   In `scripts/seed.ts`, seed `ServiceCategory` for each `ServiceType` (WASH_FOLD, WASH_IRON, STEAM_IRON, DRY_CLEAN, HOME_LINEN, SHOES, ADD_ONS). Optionally backfill `ItemSegmentServicePrice` from `LaundryItemPrice` with segment = MEN.

3. **Ports + repos**  
   Add `ServiceCategoryRepo` and `ItemSegmentServicePriceRepo` ports; implement Prisma repos; register in `infra.module.ts`.

4. **Use cases**  
   Implement `listCatalogItemsWithMatrix`, `updateCatalogItemWithMatrix` (transaction: update item + replace matrix rows), `createServiceCategory`, `importCatalogFromFile` (parse CSV, validate rows, upsert items/categories/matrix), and “get import sample” (return CSV string/bytes).

5. **Admin API**  
   Add controller under `admin/catalog` (or keep under `admin/items` with new DTOs): GET items with matrix + service categories, PUT item with matrix, POST service-categories, POST import, GET import/sample. Keep existing GET/POST/PATCH/PUT :id/prices on current controller.

6. **Backward compatibility for orders**  
   Decide: (A) Only new UI writes to matrix; order flow keeps using `LaundryItemPrice`. When saving from new modal, also upsert `LaundryItemPrice` for a default segment (e.g. MEN) from the matrix so existing order/invoice code still gets prices. Or (B) leave LaundryItemPrice unchanged and add a separate “sync default segment” job later. Recommended: (A) — on `UpdateCatalogItemWithMatrix`, also upsert `LaundryItemPrice` for segment MEN (or configurable default) so no order/invoice changes.

7. **Admin Web types**  
   Add `Segment`, `ServiceCategory`, `ItemSegmentServicePrice`, `CatalogItemWithMatrix`, request/response types in `types/catalog.ts`.

8. **Admin Web hooks**  
   Add `useCatalogItemsWithMatrix`, `useUpdateItemWithMatrix`, `useServiceCategories`, `useCreateServiceCategory`, `useImportCatalog`; ensure cache invalidation on success.

9. **Catalog page**  
   Replace table with card grid; use `useCatalogItemsWithMatrix()`; add “Download sample” and “Upload” buttons; remove Edit Prices button; wire Edit to unified modal.

10. **CatalogCard component**  
    New component: name, active badge/toggle, compact matrix display, Edit button.

11. **Unified EditItemModal**  
    Redesign: name, active, segment sections (expandable), per-segment service rows (price + active), “Add service category” control, Save calling PUT item-with-matrix, success toast and invalidate queries.

12. **Remove EditPricesModal**  
    Delete component and all usages from catalog page.

13. **Import flow**  
    Implement upload UI (file input for CSV), call POST import, show summary (created/updated/errors). Implement GET import/sample and “Download sample” button.

14. **Manual test**  
    Create item, edit with matrix, add service category, save, verify card and list; upload CSV and verify summary; ensure existing GET/PATCH and PUT prices still work if called directly.

---

## 5. Test Plan

### Manual steps

1. **Catalog list**  
   Open Catalog; confirm items appear as cards with name, active toggle, and price matrix (segment → service → ₹). Toggle active on a card and confirm it updates.

2. **Unified Edit**  
   Click Edit on an item; change name, toggle active, add/change prices in different segments (e.g. MEN: STEAM_IRON ₹10, DRY_CLEAN ₹50; WOMEN: STEAM_IRON ₹20). Add a new service category from the modal, then set a price for it. Save; confirm success toast and card content updates.

3. **Validation**  
   In Edit modal: clear name → Save → expect “Name required”. Enter negative or decimal price → expect validation. Leave price blank → expect treated as not set / inactive.

4. **Import**  
   Click “Download sample”; open CSV and check columns. Upload a CSV with new item name, segment, service code, price; confirm summary shows created/updated; confirm item appears in catalog with correct matrix.

5. **Backward compatibility**  
   Call `GET /admin/items?withPrices=true` and confirm existing shape still works. If applicable, create an order that uses an item and confirm price resolution still works (if we implemented default-segment sync to LaundryItemPrice).

### Quick automated tests (optional)

- Unit test for `updateCatalogItemWithMatrix` (transaction replaces matrix rows, optional default-segment sync to LaundryItemPrice).
- Unit test for CSV import use case (valid rows create/update; invalid rows return errors by row).
- Integration test: GET catalog/items returns items with segmentPrices and serviceCategories.

---

## 6. Root Cause of Current “Edit prices” Save Bug

- **File:** `apps/admin-web/components/catalog/EditPricesModal.tsx`
- **Cause:** `SERVICE_TYPES` array uses `'WASH&FOLD'` (line 21) instead of the enum value `'WASH_FOLD'`. The backend validates `serviceType` with `@IsEnum(ServiceType)` in `ItemPriceItemDto`, so the first price row fails validation and the PUT returns 400 (or similar), and Save appears not to work.
- **Fix:** Removing the Edit Prices modal and replacing it with the unified Edit Item modal and new API removes this code path and fixes the bug.

---

*End of plan. Proceed to implementation only after confirmation.*
